name: "ðŸ¤– Amazon Q Auto Infrastructure Generation"

on:
  push:
    branches: [ main ]
    paths: 
      - 'skyline_system_demo/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  amazon-q-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Amazon Q Code Analysis
        run: |
          echo "ðŸ¤– Amazon Q ì½”ë“œ ë¶„ì„ ì‹œìž‘..."
          echo "ðŸ“‚ ë¶„ì„ ëŒ€ìƒ: skyline_system_demo/"
          
          cd automation
          python pipeline.py

      - name: Validate Generated Infrastructure
        run: |
          echo "ðŸ” Amazon Q ìƒì„± ê²°ê³¼ ê²€ì¦..."
          
          if [ -f "analysis.json" ]; then
            echo "âœ… Amazon Q ë¶„ì„ ê²°ê³¼:"
            cat analysis.json | jq '.recommendations'
          fi
          
          if [ -f "generated/terraform/main.tf" ]; then
            echo "âœ… Terraform ì½”ë“œ ìƒì„±ë¨ (Amazon Q ê¸°ë°˜)"
            grep -o "# Generated by Amazon Q" generated/terraform/main.tf
          fi
          
          if [ -f "generated/k8s/deployment.yaml" ]; then
            echo "âœ… K8s ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ìƒì„±ë¨ (Amazon Q ê¸°ë°˜)"
            grep -o "generated-by: amazon-q" generated/k8s/deployment.yaml
          fi

      - name: Deploy Infrastructure (Amazon Q Generated)
        run: |
          echo "ðŸ—ï¸ Amazon Q ìƒì„± ì¸í”„ë¼ ë°°í¬..."
          echo "ðŸŽ¯ AI ê¶Œìž¥ì‚¬í•­ ì ìš© ì¤‘..."
          
          # Terraform ë°°í¬ (ì‹œë®¬ë ˆì´ì…˜)
          echo "ðŸ“‹ Terraform Plan (AI Generated)..."
          # cd generated/terraform && terraform plan
          
          echo "ðŸš€ Terraform Apply (AI Generated)..."
          # cd generated/terraform && terraform apply -auto-approve
          
          echo "âœ… ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ (Amazon Q ê¸°ë°˜)"

      - name: Deploy Application (Amazon Q Generated)
        run: |
          echo "ðŸš€ Amazon Q ìƒì„± K8s ë°°í¬..."
          
          # K8s ë°°í¬ (ì‹œë®¬ë ˆì´ì…˜)
          echo "ðŸ“¦ K8s ë¦¬ì†ŒìŠ¤ ì ìš© ì¤‘..."
          # kubectl apply -f generated/k8s/deployment.yaml
          
          echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì™„ë£Œ (Amazon Q ê¸°ë°˜)"

      - name: Amazon Q Summary
        run: |
          echo "## ðŸ¤– Amazon Q ìžë™ ì¸í”„ë¼ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š AI ë¶„ì„ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "analysis.json" ]; then
            echo "- **ì•± íƒ€ìž…**: $(cat analysis.json | jq -r '.app_type')" >> $GITHUB_STEP_SUMMARY
            echo "- **ì–¸ì–´**: $(cat analysis.json | jq -r '.language')" >> $GITHUB_STEP_SUMMARY
            echo "- **í¬íŠ¸**: $(cat analysis.json | jq -r '.port')" >> $GITHUB_STEP_SUMMARY
            echo "- **ê¶Œìž¥ ì»´í“¨íŒ…**: $(cat analysis.json | jq -r '.recommendations.compute')" >> $GITHUB_STEP_SUMMARY
            echo "- **ê¶Œìž¥ DB**: $(cat analysis.json | jq -r '.recommendations.database')" >> $GITHUB_STEP_SUMMARY
            echo "- **ì¸ìŠ¤í„´ìŠ¤ íƒ€ìž…**: $(cat analysis.json | jq -r '.recommendations.instance_type')" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Terraform**: Amazon Q ë¶„ì„ ê¸°ë°˜ ì¸í”„ë¼ ì½”ë“œ" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Kubernetes**: AI ìµœì í™” ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ë°°í¬**: demo.greenbespinglobal.store" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– **Powered by Amazon Q AI**" >> $GITHUB_STEP_SUMMARY
