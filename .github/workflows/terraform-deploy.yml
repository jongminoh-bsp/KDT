name: ğŸš€ AI-Generated Infrastructure Deployment

on:
  pull_request:
    types: [closed]
    branches: [dev]
    paths: ['terraform/**']

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: 1.5.0

jobs:
  # PRì´ ë¨¸ì§€ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
  deploy-infrastructure:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: ğŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-TerraformDeploy
    
    - name: ğŸ“‹ Terraform Init
      working-directory: terraform
      run: |
        terraform init
        echo "âœ… Terraform initialized successfully"
    
    - name: ğŸ” Terraform Validate
      working-directory: terraform
      run: |
        terraform validate
        echo "âœ… Terraform configuration is valid"
    
    - name: ğŸ“Š Terraform Plan
      working-directory: terraform
      run: |
        terraform plan -out=tfplan
        echo "âœ… Terraform plan generated"
    
    - name: ğŸš€ Terraform Apply
      working-directory: terraform
      run: |
        terraform apply -auto-approve tfplan
        echo "âœ… Infrastructure deployed successfully"
    
    - name: ğŸ“¤ Save Terraform Outputs
      working-directory: terraform
      run: |
        terraform output -json > terraform-outputs.json
        echo "âœ… Terraform outputs saved"
    
    - name: âš™ï¸ Configure kubectl
      run: |
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name $(terraform -chdir=terraform output -raw eks_cluster_name)
        kubectl get nodes
        echo "âœ… kubectl configured for EKS cluster"
    
    - name: ğŸ“ Create Deployment Summary
      run: |
        echo "## ğŸ‰ Infrastructure Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ—ï¸ Deployed Resources" >> $GITHUB_STEP_SUMMARY
        echo "- **EKS Cluster**: $(terraform -chdir=terraform output -raw eks_cluster_name)" >> $GITHUB_STEP_SUMMARY
        echo "- **VPC ID**: $(terraform -chdir=terraform output -raw vpc_id)" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Infrastructure is ready" >> $GITHUB_STEP_SUMMARY
        echo "2. ğŸ”„ Kubernetes manifests will be auto-generated" >> $GITHUB_STEP_SUMMARY
        echo "3. ğŸ“¦ Application deployment PR will be created" >> $GITHUB_STEP_SUMMARY
        echo "4. ğŸŒ Domain configuration will be applied" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ’¬ Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Terraform outputs ì½ê¸°
          let outputs = {};
          try {
            outputs = JSON.parse(fs.readFileSync('terraform/terraform-outputs.json', 'utf8'));
          } catch (e) {
            console.log('Could not read terraform outputs');
          }
          
          const comment = `## ğŸ‰ Infrastructure Deployment Successful!
          
          **Deployment Time**: ${new Date().toISOString()}
          **AWS Region**: ${{ env.AWS_REGION }}
          
          ### ğŸ—ï¸ Created Resources
          - **EKS Cluster**: ${outputs.eks_cluster_name?.value || 'Created'}
          - **VPC**: ${outputs.vpc_id?.value || 'Created'}
          - **RDS Database**: ${outputs.rds_endpoint?.value ? 'âœ… Created' : 'âŒ Not Required'}
          
          ### ğŸ¯ What's Next?
          1. **Kubernetes Ready**: EKS cluster is operational
          2. **Application Deployment**: Next PR will deploy the application
          3. **Domain Setup**: SSL certificate and domain configuration
          4. **Monitoring**: CloudWatch and logging configured
          
          ### ğŸ”— Quick Access
          \`\`\`bash
          # Connect to EKS cluster
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${outputs.eks_cluster_name?.value || 'cluster-name'}
          
          # Check cluster status
          kubectl get nodes
          kubectl get pods --all-namespaces
          \`\`\`
          
          **ğŸš€ Infrastructure is ready for application deployment!**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: ğŸ·ï¸ Add Success Label
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['âœ… deployed', 'infrastructure-ready']
          });

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-failure:
    if: failure() && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: ğŸš¨ Deployment Failed Notification
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸš¨ Infrastructure Deployment Failed
          
          **Failure Time**: ${new Date().toISOString()}
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          
          ### ğŸ” Troubleshooting Steps
          1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. Verify AWS credentials and permissions
          3. Check Terraform configuration syntax
          4. Ensure AWS resource limits are not exceeded
          
          ### ğŸ› ï¸ Common Issues
          - **AWS Permissions**: Ensure the GitHub Actions role has sufficient permissions
          - **Resource Limits**: Check if AWS account has reached service limits
          - **Terraform State**: Verify Terraform state is not corrupted
          
          **Please review the logs and retry the deployment.**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['âŒ deployment-failed', 'needs-investigation']
          });
