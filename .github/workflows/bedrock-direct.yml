name: 🤖 Direct Bedrock Test

on:
  workflow_dispatch:
  push:
    branches: [dev]
    paths: ['test_app/**']

jobs:
  bedrock-direct:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install boto3
      run: pip install boto3>=1.34.0
    
    - name: Test Bedrock Direct
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: |
        python3 << 'EOF'
        import boto3
        import json
        import os
        
        try:
            print("🤖 Testing Amazon Bedrock with direct credentials...")
            print(f"Region: {os.getenv('AWS_DEFAULT_REGION')}")
            
            # Bedrock 클라이언트 생성
            client = boto3.client('bedrock-runtime', region_name='us-east-1')
            print("✅ Bedrock client created")
            
            # 실제 Claude 호출
            response = client.invoke_model(
                modelId='anthropic.claude-3-haiku-20240307-v1:0',
                body=json.dumps({
                    "anthropic_version": "bedrock-2023-05-31",
                    "max_tokens": 300,
                    "messages": [{
                        "role": "user", 
                        "content": "Analyze this Node.js application: Express server with MongoDB and Redis dependencies. What AWS infrastructure would you recommend? Please respond with a brief JSON containing framework, database_type, cache_type, recommended_memory, and recommended_replicas."
                    }]
                })
            )
            
            # 응답 파싱
            result = json.loads(response['body'].read())
            ai_response = result['content'][0]['text']
            
            print("\n🎉 SUCCESS! Real Amazon Bedrock Claude Analysis:")
            print("=" * 70)
            print(ai_response)
            print("=" * 70)
            print("\n✅ Amazon Bedrock is working in GitHub Actions!")
            print("🤖 This is real AI analysis from Claude!")
            
        except Exception as e:
            print(f"❌ Bedrock test failed: {e}")
            import traceback
            traceback.print_exc()
            exit(1)
        EOF
