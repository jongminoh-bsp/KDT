name: 🤖 Bedrock Seoul Region Test

on:
  workflow_dispatch:
  push:
    branches: [dev]
    paths: ['test_app/**']

jobs:
  bedrock-seoul:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install boto3
      run: pip install boto3>=1.34.0
    
    - name: Test Bedrock Seoul Region
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ap-northeast-2
      run: |
        python3 << 'EOF'
        import boto3
        import json
        
        try:
            print("🤖 Testing Amazon Bedrock in Seoul region (ap-northeast-2)...")
            
            # Seoul 리전으로 Bedrock 클라이언트 생성
            client = boto3.client('bedrock-runtime', region_name='ap-northeast-2')
            print("✅ Bedrock client created for Seoul region")
            
            # Claude 3 Haiku 호출 (Seoul 리전)
            response = client.invoke_model(
                modelId='anthropic.claude-3-haiku-20240307-v1:0',
                body=json.dumps({
                    "anthropic_version": "bedrock-2023-05-31",
                    "max_tokens": 500,
                    "messages": [{
                        "role": "user", 
                        "content": "Analyze this Node.js application: Express server with MongoDB and Redis dependencies. What AWS infrastructure would you recommend? Please respond in JSON format with framework, database_type, cache_type, recommended_memory_gb, recommended_replicas, and estimated_monthly_cost_usd."
                    }]
                })
            )
            
            # 응답 파싱
            result = json.loads(response['body'].read())
            ai_response = result['content'][0]['text']
            
            print("\n🎉 SUCCESS! Real Amazon Bedrock Claude Analysis from Seoul:")
            print("=" * 80)
            print(ai_response)
            print("=" * 80)
            print("\n✅ Amazon Bedrock is working in Seoul region!")
            print("🤖 This is real AI analysis from Claude in ap-northeast-2!")
            print("🇰🇷 Seoul region Bedrock connection successful!")
            
        except Exception as e:
            print(f"❌ Bedrock test failed: {e}")
            import traceback
            traceback.print_exc()
            exit(1)
        EOF
