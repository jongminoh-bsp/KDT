name: ğŸ¤– Auto AI Analysis on Code Push

on:
  push:
    branches: [dev]
    paths: 
      - 'application/**'  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ê²½ë¡œ
      - 'src/**'          # ì†ŒìŠ¤ ì½”ë“œ
      - 'pom.xml'         # Maven ì„¤ì •
      - 'package.json'    # Node.js ì„¤ì •
      - 'requirements.txt' # Python ì„¤ì •

env:
  APPLICATION_PATH: /home/ojm/skyline_system_demo

jobs:
  ai-analysis-and-infrastructure:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“‹ Install Dependencies
      run: |
        pip install -r requirements.txt || echo "No requirements.txt found"
    
    - name: ğŸ” Run AI Code Analysis
      run: |
        echo "ğŸ¤– Starting Amazon Q AI Analysis..."
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
        if [ -d "src/" ] || [ -f "pom.xml" ] || [ -f "package.json" ]; then
          echo "âœ… Application code detected in repository"
          
          # AI ë¶„ì„ ì‹¤í–‰
          python3 automation/analyzer/code_analyzer.py ./ > analysis_output.txt
          
          echo "ğŸ“Š Analysis completed"
          cat analysis_output.txt
        else
          echo "âŒ No application code found in repository"
          exit 0
        fi
    
    - name: ğŸ—ï¸ Generate Infrastructure Code
      run: |
        echo "ğŸ—ï¸ Generating Terraform infrastructure..."
        python3 automation/full_pipeline.py
    
    - name: ğŸ”„ Create Infrastructure PR
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Git ì„¤ì •
        git config --global user.name "Amazon Q AI"
        git config --global user.email "ai@amazonq.aws"
        
        # ë¸Œëœì¹˜ ìƒì„±
        BRANCH_NAME="infrastructure/ai-generated-$(date +%Y%m%d_%H%M%S)"
        git checkout -b $BRANCH_NAME
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        git add terraform/ reports/ analysis_summary.json
        git commit -m "ğŸ¤– AI-Generated Infrastructure
        
        - Analyzed application code automatically
        - Generated optimized Terraform configuration
        - Created deployment-ready infrastructure
        
        Generated by Amazon Q AI Engine"
        
        # ë¸Œëœì¹˜ í‘¸ì‹œ
        git push origin $BRANCH_NAME
        
        # PR ìƒì„±
        gh pr create \
          --title "ğŸ¤– AI-Generated Infrastructure (Auto-triggered)" \
          --body "## ğŸ” Automatic AI Analysis
        
        This PR was **automatically generated** when application code was pushed to the repository.
        
        ### ğŸ“Š Analysis Results
        - **Trigger**: Code push to \`dev\` branch
        - **Timestamp**: $(date)
        - **AI Engine**: Amazon Q Code Analyzer
        
        ### ğŸ—ï¸ Generated Infrastructure
        - Complete Terraform configuration
        - Optimized resource sizing
        - Security best practices applied
        
        ### ğŸš€ Next Steps
        1. Review the generated Terraform code
        2. Approve this PR to deploy infrastructure
        3. GitHub Actions will handle the deployment
        
        **This is fully automated - no manual intervention required!** ğŸ¤–" \
          --base dev \
          --head $BRANCH_NAME \
          --label "ai-generated,infrastructure,auto-triggered"

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-failure:
    if: failure()
    runs-on: ubuntu-latest
    needs: ai-analysis-and-infrastructure
    
    steps:
    - name: ğŸš¨ Analysis Failed
      run: |
        echo "âŒ AI analysis pipeline failed"
        echo "Check the workflow logs for details"
