name: ğŸ¤– Enhanced Auto AI Analysis (Full Directory Support)

on:
  push:
    branches: [dev]
    paths: 
      # ê°œë³„ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ë“¤
      - 'src/**'
      - 'pom.xml'
      - 'package.json'
      - 'requirements.txt'
      - 'build.gradle'
      - 'Dockerfile'
      # ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í„°ë¦¬ë“¤
      - 'skyline_system_demo/**'
      - 'application/**'
      - 'app/**'
      - 'backend/**'
      - 'frontend/**'
      - '**/pom.xml'
      - '**/package.json'
      - '**/requirements.txt'

jobs:
  detect-and-analyze:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    outputs:
      has_apps: ${{ steps.detect.outputs.has_apps }}
      main_app: ${{ steps.detect.outputs.main_app }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ” Smart Application Detection
      id: detect
      run: |
        echo "ğŸ” Scanning for application code..."
        
        APP_DIRS=""
        
        # 1. skyline_system_demo ìš°ì„  í™•ì¸
        if [ -d "skyline_system_demo" ]; then
          echo "âœ… Found skyline_system_demo directory"
          APP_DIRS="skyline_system_demo"
        fi
        
        # 2. ë£¨íŠ¸ ë ˆë²¨ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ë“¤
        if [ -f "pom.xml" ] || [ -f "package.json" ] || [ -f "requirements.txt" ]; then
          echo "âœ… Root level application detected"
          APP_DIRS="$APP_DIRS ./"
        fi
        
        # 3. ì¼ë°˜ì ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í„°ë¦¬ë“¤
        for dir in application app backend frontend src; do
          if [ -d "$dir" ]; then
            if [ -f "$dir/pom.xml" ] || [ -f "$dir/package.json" ] || [ -f "$dir/requirements.txt" ]; then
              echo "âœ… Application found in: $dir"
              APP_DIRS="$APP_DIRS $dir"
            fi
          fi
        done
        
        # 4. ì†ŒìŠ¤ ì½”ë“œê°€ ìˆëŠ” ë””ë ‰í„°ë¦¬ ì°¾ê¸°
        find . -maxdepth 2 -name "*.java" -o -name "*.js" -o -name "*.py" | head -5 | while read file; do
          dir=$(dirname "$file")
          if [ "$dir" != "." ] && [[ ! "$APP_DIRS" == *"$dir"* ]]; then
            echo "âœ… Source code found in: $dir"
            APP_DIRS="$APP_DIRS $dir"
          fi
        done
        
        # ì¤‘ë³µ ì œê±° ë° ì •ë¦¬
        APP_DIRS=$(echo $APP_DIRS | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
        
        echo "ğŸ“‹ Detected directories: $APP_DIRS"
        
        # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„ íƒ (ìš°ì„ ìˆœìœ„: skyline > ì²« ë²ˆì§¸)
        MAIN_APP=""
        for app_dir in $APP_DIRS; do
          if [[ "$app_dir" == *"skyline"* ]]; then
            MAIN_APP="$app_dir"
            break
          fi
        done
        
        if [ -z "$MAIN_APP" ] && [ -n "$APP_DIRS" ]; then
          MAIN_APP=$(echo "$APP_DIRS" | awk '{print $1}')
        fi
        
        if [ -n "$MAIN_APP" ]; then
          echo "ğŸ¯ Main application: $MAIN_APP"
          echo "has_apps=true" >> $GITHUB_OUTPUT
          echo "main_app=$MAIN_APP" >> $GITHUB_OUTPUT
        else
          echo "âŒ No application code detected"
          echo "has_apps=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ¤– Run AI Analysis
      if: steps.detect.outputs.has_apps == 'true'
      run: |
        MAIN_APP="${{ steps.detect.outputs.main_app }}"
        echo "ğŸ¤– Analyzing application: $MAIN_APP"
        
        # ì ˆëŒ€ ê²½ë¡œ ìƒì„±
        if [ "$MAIN_APP" = "./" ]; then
          ANALYSIS_PATH="$(pwd)"
        else
          ANALYSIS_PATH="$(pwd)/$MAIN_APP"
        fi
        
        echo "ğŸ“ Analysis path: $ANALYSIS_PATH"
        
        # AI ë¶„ì„ ì‹¤í–‰
        python3 automation/analyzer/code_analyzer.py "$ANALYSIS_PATH" > analysis_output.txt
        
        echo "ğŸ“Š Analysis Results:"
        cat analysis_output.txt
        
        # ë¶„ì„ ê²°ê³¼ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
        echo "ANALYSIS_PATH=$ANALYSIS_PATH" >> $GITHUB_ENV
    
    - name: ğŸ—ï¸ Generate Infrastructure
      if: steps.detect.outputs.has_apps == 'true'
      run: |
        echo "ğŸ—ï¸ Generating Terraform infrastructure..."
        
        # config.py ì—…ë°ì´íŠ¸
        sed -i "s|APPLICATION_SOURCE_PATH = \".*\"|APPLICATION_SOURCE_PATH = \"$ANALYSIS_PATH\"|" automation/config.py
        
        # ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (PR ìƒì„± ì œì™¸)
        python3 -c "
import sys, os
sys.path.append('automation')
os.chdir('$(pwd)')

from analyzer.code_analyzer import ApplicationAnalyzer
from analyzer.report_generator import AnalysisReportGenerator  
from generator.terraform_generator import TerraformGenerator
import config
import json

print('ğŸ” Analyzing:', config.APPLICATION_SOURCE_PATH)
analyzer = ApplicationAnalyzer(config.APPLICATION_SOURCE_PATH)
result = analyzer.analyze()

print('ğŸ“Š Generating report...')
os.makedirs('reports', exist_ok=True)
report_gen = AnalysisReportGenerator(result, config.APPLICATION_SOURCE_PATH)
report_file = report_gen.save_report('./reports')

summary = report_gen.generate_json_summary()
with open('analysis_summary.json', 'w') as f:
    json.dump(summary, f, indent=2)

print('ğŸ—ï¸ Generating Terraform...')
terraform_config = {
    'AWS_REGION': getattr(config, 'AWS_REGION', 'ap-northeast-2'),
    'PROJECT_NAME': getattr(config, 'PROJECT_NAME', 'skyline'),
    'ENVIRONMENT': getattr(config, 'ENVIRONMENT', 'dev'),
    'ECR_IMAGE_URI': getattr(config, 'ECR_IMAGE_URI', '646558765106.dkr.ecr.ap-northeast-2.amazonaws.com/skyline-dev:latest'),
    'DOMAIN_NAME': getattr(config, 'DOMAIN_NAME', 'www.greenbespinglobal.store')
}

terraform_gen = TerraformGenerator(result, terraform_config)
terraform_files = terraform_gen.generate_all('./generated_terraform')

print('âœ… Generation complete!')
print(f'ğŸ“± Framework: {result[\"framework\"]}')
print(f'ğŸ”„ Replicas: {result[\"resources\"][\"replicas\"]}')
print(f'ğŸ’¾ Memory: {result[\"resources\"][\"memory_limit\"]}')
"
    
    - name: ğŸ”„ Create Auto PR
      if: steps.detect.outputs.has_apps == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        MAIN_APP="${{ steps.detect.outputs.main_app }}"
        
        # Git ì„¤ì •
        git config --global user.name "Amazon Q AI"
        git config --global user.email "ai@amazonq.aws"
        
        # ë¸Œëœì¹˜ ìƒì„±
        BRANCH_NAME="auto-infra/$(echo $MAIN_APP | tr '/' '-')-$(date +%Y%m%d_%H%M%S)"
        git checkout -b $BRANCH_NAME
        
        # Terraform íŒŒì¼ ì •ë¦¬
        mkdir -p terraform
        if [ -d "generated_terraform" ]; then
          cp -r generated_terraform/* terraform/ 2>/dev/null || true
        fi
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        git add terraform/ reports/ analysis_summary.json automation/config.py 2>/dev/null || true
        git commit -m "ğŸ¤– Auto-Infrastructure: $MAIN_APP

ğŸ“± Application: $MAIN_APP
ğŸ” Auto-detected and analyzed
ğŸ—ï¸ Generated Terraform infrastructure
ğŸš€ Ready for deployment

Generated by Amazon Q AI Engine
Timestamp: $(date)" || echo "No changes to commit"
        
        # ë¸Œëœì¹˜ í‘¸ì‹œ
        git push origin $BRANCH_NAME
        
        # PR ìƒì„±
        gh pr create \
          --title "ğŸ¤– Auto-Infrastructure: $(basename $MAIN_APP)" \
          --body "## ğŸ” Automatic Application Detection

**Detected Application**: \`$MAIN_APP\`  
**Detection Time**: $(date)  
**AI Engine**: Amazon Q Code Analyzer  

### ğŸ“Š What Happened
1. **Code Push Detected** â†’ Application directory identified
2. **AI Analysis** â†’ Code structure and dependencies analyzed  
3. **Infrastructure Generated** â†’ Terraform code created automatically
4. **PR Created** â†’ This pull request generated for review

### ğŸ—ï¸ Generated Infrastructure
- **VPC**: Multi-AZ networking setup
- **EKS**: Kubernetes cluster (auto-sized)
- **RDS**: Database (if required by application)
- **Security**: IAM roles and security groups

### ğŸ¯ Application Analysis Results
- **Type**: Auto-detected from code structure
- **Framework**: Identified via file analysis
- **Resources**: Optimized based on complexity
- **Dependencies**: External services catalogued

### ğŸš€ Next Steps
1. **Review** the generated Terraform in \`terraform/\` directory
2. **Approve** this PR to trigger infrastructure deployment
3. **GitHub Actions** will deploy everything automatically
4. **EKS cluster** will be ready for your application

### ğŸ“‹ Files Generated
- \`terraform/main.tf\` - Main infrastructure configuration
- \`terraform/modules/\` - Modular resource definitions
- \`reports/\` - Detailed analysis report
- \`analysis_summary.json\` - Machine-readable summary

**This PR was created automatically by Amazon Q AI!** ğŸ¤–

**Ready for review and deployment!** âœ…" \
          --base dev \
          --head $BRANCH_NAME \
          --label "ai-generated,auto-detected,infrastructure"

  # ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš° ì•Œë¦¼
  no-apps-found:
    if: always() && needs.detect-and-analyze.outputs.has_apps != 'true'
    runs-on: ubuntu-latest
    needs: detect-and-analyze
    
    steps:
    - name: ğŸ“ No Applications Detected
      run: |
        echo "â„¹ï¸ No application code detected in this push"
        echo ""
        echo "ğŸ” Amazon Q AI looks for:"
        echo "  ğŸ“ Directories: skyline_system_demo/, application/, app/, backend/, frontend/, src/"
        echo "  ğŸ“„ Files: pom.xml, package.json, requirements.txt, build.gradle"
        echo "  ğŸ’» Source: .java, .js, .py, .ts files"
        echo ""
        echo "ğŸ’¡ To trigger AI analysis, push:"
        echo "  - Complete application directory (like skyline_system_demo/)"
        echo "  - Individual application files to supported paths"
        echo ""
        echo "ğŸ¤– Amazon Q AI will automatically detect and analyze your code!"
