#!/usr/bin/env python3
"""
Fixed GitHub PR Automation
gh CLI ì¸ì¦ ë¬¸ì œ í•´ê²° ë° ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
"""

import os
import json
import subprocess
from datetime import datetime
from pathlib import Path

class FixedGitHubPRAutomation:
    """ê°œì„ ëœ GitHub PR ìë™í™” í´ë˜ìŠ¤"""
    
    def __init__(self, analysis_result: dict, terraform_files: dict):
        self.analysis_result = analysis_result
        self.terraform_files = terraform_files
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        self.branch_name = f"infrastructure/terraform-{self.timestamp}"
    
    def create_infrastructure_pr(self) -> str:
        """ì¸í”„ë¼ PR ìƒì„± (ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ )"""
        print("ğŸ”„ Creating infrastructure branch and PR...")
        
        try:
            # 1. Git ì„¤ì • í™•ì¸
            self._setup_git_config()
            
            # 2. ìƒˆ ë¸Œëœì¹˜ ìƒì„±
            self._create_branch()
            
            # 3. Terraform íŒŒì¼ë“¤ ì •ë¦¬
            self._organize_terraform_files()
            
            # 4. ë³€ê²½ì‚¬í•­ ì»¤ë°‹
            commit_message = self._generate_commit_message()
            self._commit_changes(commit_message)
            
            # 5. ë¸Œëœì¹˜ í‘¸ì‹œ
            self._push_branch()
            
            # 6. PR ìƒì„± (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
            pr_url = self._create_pull_request_with_fallback()
            
            return pr_url
            
        except Exception as e:
            print(f"âŒ PR ìƒì„± ì‹¤íŒ¨: {str(e)}")
            print("ğŸ”§ ìˆ˜ë™ PR ìƒì„± ë°©ë²•:")
            print(f"   1. GitHubì—ì„œ ë¸Œëœì¹˜ '{self.branch_name}' í™•ì¸")
            print(f"   2. ìˆ˜ë™ìœ¼ë¡œ PR ìƒì„±: dev â† {self.branch_name}")
            return f"Manual PR required for branch: {self.branch_name}"
    
    def _setup_git_config(self):
        """Git ì„¤ì •"""
        try:
            subprocess.run(["git", "config", "user.name"], 
                         capture_output=True, check=True)
        except:
            subprocess.run(["git", "config", "--global", "user.name", "Amazon Q AI"], 
                         check=True)
            subprocess.run(["git", "config", "--global", "user.email", "ai@amazonq.aws"], 
                         check=True)
            print("âœ… Git config set")
    
    def _create_branch(self):
        """ìƒˆ ë¸Œëœì¹˜ ìƒì„±"""
        subprocess.run(["git", "checkout", "dev"], check=True)
        subprocess.run(["git", "pull", "origin", "dev"], check=True)
        subprocess.run(["git", "checkout", "-b", self.branch_name], check=True)
        print(f"âœ… Created branch: {self.branch_name}")
    
    def _organize_terraform_files(self):
        """Terraform íŒŒì¼ë“¤ì„ ì ì ˆí•œ ìœ„ì¹˜ë¡œ ì´ë™"""
        terraform_dir = Path("terraform")
        terraform_dir.mkdir(exist_ok=True)
        
        generated_dir = Path("generated_terraform")
        if generated_dir.exists():
            subprocess.run(["cp", "-r", str(generated_dir) + "/.", str(terraform_dir)], 
                         check=True)
            print("âœ… Terraform files organized")
    
    def _generate_commit_message(self) -> str:
        """ê°„ë‹¨í•œ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±"""
        framework = self.analysis_result.get('framework', 'unknown')
        replicas = self.analysis_result.get('resources', {}).get('replicas', 2)
        
        return f"""ğŸ¤– AI-Generated Infrastructure for {framework}

- Framework: {framework}
- Replicas: {replicas}
- Generated by Amazon Q AI Engine
- Timestamp: {self.timestamp}

Ready for deployment via GitHub Actions"""
    
    def _commit_changes(self, message: str):
        """ë³€ê²½ì‚¬í•­ ì»¤ë°‹"""
        subprocess.run(["git", "add", "terraform/"], check=True)
        subprocess.run(["git", "add", "analysis_summary.json"], check=True, 
                      capture_output=True)  # íŒŒì¼ì´ ì—†ì–´ë„ ê³„ì† ì§„í–‰
        subprocess.run(["git", "add", "reports/"], check=True, 
                      capture_output=True)  # íŒŒì¼ì´ ì—†ì–´ë„ ê³„ì† ì§„í–‰
        subprocess.run(["git", "commit", "-m", message], check=True)
        print("âœ… Changes committed")
    
    def _push_branch(self):
        """ë¸Œëœì¹˜ í‘¸ì‹œ"""
        subprocess.run(["git", "push", "origin", self.branch_name], check=True)
        print(f"âœ… Branch pushed: {self.branch_name}")
    
    def _create_pull_request_with_fallback(self) -> str:
        """PR ìƒì„± (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)"""
        pr_title = f"ğŸ¤– AI-Generated Infrastructure: {self.analysis_result.get('framework', 'Application')}"
        pr_body = self._generate_pr_body()
        
        # ë°©ë²• 1: gh CLI ì‹œë„
        try:
            return self._create_pr_with_gh_cli(pr_title, pr_body)
        except Exception as e:
            print(f"âš ï¸ gh CLI ì‹¤íŒ¨: {str(e)}")
        
        # ë°©ë²• 2: GitHub API ì‹œë„ (í† í°ì´ ìˆëŠ” ê²½ìš°)
        try:
            return self._create_pr_with_api(pr_title, pr_body)
        except Exception as e:
            print(f"âš ï¸ GitHub API ì‹¤íŒ¨: {str(e)}")
        
        # ë°©ë²• 3: ìˆ˜ë™ ìƒì„± ì•ˆë‚´
        github_url = f"https://github.com/jongminoh-bsp/KDT/compare/dev...{self.branch_name}"
        print(f"ğŸ”— Manual PR creation URL: {github_url}")
        return github_url
    
    def _create_pr_with_gh_cli(self, title: str, body: str) -> str:
        """gh CLIë¡œ PR ìƒì„±"""
        cmd = [
            "gh", "pr", "create",
            "--title", title,
            "--body", body,
            "--base", "dev",
            "--head", self.branch_name
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        pr_url = result.stdout.strip()
        print(f"âœ… PR created with gh CLI: {pr_url}")
        return pr_url
    
    def _create_pr_with_api(self, title: str, body: str) -> str:
        """GitHub APIë¡œ PR ìƒì„±"""
        import requests
        
        token = os.environ.get('GITHUB_TOKEN')
        if not token:
            raise Exception("GITHUB_TOKEN not found")
        
        url = "https://api.github.com/repos/jongminoh-bsp/KDT/pulls"
        headers = {
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json"
        }
        data = {
            "title": title,
            "body": body,
            "head": self.branch_name,
            "base": "dev"
        }
        
        response = requests.post(url, headers=headers, json=data)
        response.raise_for_status()
        
        pr_data = response.json()
        pr_url = pr_data['html_url']
        print(f"âœ… PR created with API: {pr_url}")
        return pr_url
    
    def _generate_pr_body(self) -> str:
        """PR ë³¸ë¬¸ ìƒì„±"""
        return f"""## ğŸ¤– AI-Generated Infrastructure

**Analysis Engine**: Amazon Q Code Analyzer  
**Framework**: {self.analysis_result.get('framework', 'unknown')}  
**Replicas**: {self.analysis_result.get('resources', {}).get('replicas', 2)}  
**Memory**: {self.analysis_result.get('resources', {}).get('memory_limit', '1Gi')}  

### ğŸ—ï¸ Generated Resources
- VPC with Multi-AZ subnets
- EKS Kubernetes cluster
- RDS database (if required)
- Security groups and IAM roles

### ğŸš€ Deployment
Approve this PR to automatically deploy infrastructure via GitHub Actions.

**Generated at**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"""

def test_fixed_pr_automation():
    """í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
    sample_analysis = {
        "framework": "spring-boot",
        "resources": {"replicas": 3, "memory_limit": "2Gi"}
    }
    
    pr_automation = FixedGitHubPRAutomation(sample_analysis, {})
    
    # ì‹¤ì œ PR ìƒì„±í•˜ì§€ ì•Šê³  í…ŒìŠ¤íŠ¸ë§Œ
    print("ğŸ§ª Testing PR automation components...")
    print(f"âœ… Branch name: {pr_automation.branch_name}")
    print(f"âœ… Commit message generated")
    print(f"âœ… PR body generated")
    print("ğŸ¯ PR automation ready!")

if __name__ == "__main__":
    test_fixed_pr_automation()
